<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>聊天</title>
    
    <!-- CSS文件引入 -->
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/chat/chat-common.css">
    <link rel="stylesheet" href="css/chat/modal.css">
    <link rel="stylesheet" href="css/chat/chat-list.css">
    <link rel="stylesheet" href="css/chat/friend-list.css">
    <link rel="stylesheet" href="css/chat/discover.css">
    <link rel="stylesheet" href="css/chat/profile.css">
    <link rel="stylesheet" href="css/chat/chat-interface.css">  <!-- ← 加这行 -->
</head>
<body>
    
    <!-- 聊天APP容器 -->
    <div class="chat-app-container">
        
        <!-- 顶部导航栏 -->
        <div class="top-bar">
            <button class="back-btn" id="backBtn">
                <img src="assets/icons/chat/back.png" alt="返回">
            </button>
            <h1 class="page-title" id="pageTitle">聊天</h1>
            <div class="top-right-btns" id="topRightBtns">
                <!-- 聊天列表的按钮（默认显示） -->
                <button class="search-btn page-btn chat-list-btn" id="searchChatBtn" title="搜索聊天记录">
                    <img src="assets/icons/chat/search-chat.png" alt="搜索">
                </button>
                <button class="add-chat-btn page-btn chat-list-btn" id="addChatBtn" title="创建聊天框">
                    <img src="assets/icons/chat/add-chat.png" alt="创建聊天">
                </button>
                
                <!-- 好友列表的按钮（默认隐藏） -->
                <button class="manage-group-btn page-btn friend-list-btn" id="manageGroupBtn" title="管理分组" style="display: none;">
                    <img src="assets/icons/chat/manage-group.png" alt="管理分组">
                </button>
                <button class="add-friend-btn page-btn friend-list-btn" id="addFriendBtn" title="添加好友" style="display: none;">
                    <img src="assets/icons/chat/add-friend.png" alt="添加好友">
                </button>
            </div>
        </div>

        <!-- 页面容器 -->
        <div class="pages-container">
            
            <!-- 聊天列表页 -->
            <div class="chat-page active" id="chatListPage">
                <div class="page-content">
                    <div class="empty-placeholder">
                        <div class="empty-icon">💬</div>
                        <div class="empty-text">暂无聊天</div>
                    </div>
                </div>
            </div>
            
            <!-- 好友列表页 -->
            <div class="chat-page" id="friendListPage">
                <div class="page-content">
                    <!-- 好友列表容器 -->
                    <div id="friendListContainer"></div>
                    
                    <!-- 空状态占位（默认隐藏） -->
                    <div class="empty-placeholder" id="friendEmptyPlaceholder" style="display: none;">
                        <div class="empty-icon">👥</div>
                        <div class="empty-text">暂无好友</div>
                    </div>
                </div>
            </div>
            
            <!-- 发现页 -->
            <div class="chat-page" id="discoverPage">
                <div class="page-content">
                    <div class="empty-placeholder">
                        <div class="empty-icon">🔍</div>
                        <div class="empty-text">发现更多</div>
                    </div>
                </div>
            </div>
            
            <!-- 个人设置页 -->
            <div class="chat-page" id="profilePage">
                <div class="page-content">
                    <div class="empty-placeholder">
                        <div class="empty-icon">⚙️</div>
                        <div class="empty-text">个人设置</div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== 聊天界面页 ==================== -->
            <div class="chat-page" id="chatInterfacePage">
                <!-- 聊天界面题头 -->
                <div class="chat-interface-header">
                    <button class="chat-back-btn" id="chatBackBtn">←</button>
                    <div class="chat-friend-name" id="chatFriendName">
                        <span>加载中...</span>
                    </div>
                    <button class="offline-toggle" id="offlineToggle" title="线下模式">🔴</button>
                    <button class="chat-settings-btn" id="chatSettingsBtn" title="聊天设置">⚙️</button>
                </div>

                <!-- Token统计 -->
                <div class="token-stats" id="tokenStats">
                    <div class="token-display" id="tokenDisplay">
                        <span>Token: 0</span>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="token-details" id="tokenDetails" style="display: none;">
                        <div class="token-item">
                            <span>世界书:</span>
                            <span id="tokenWorldbook">0</span>
                        </div>
                        <div class="token-item">
                            <span>人设:</span>
                            <span id="tokenPersona">0</span>
                        </div>
                        <div class="token-item">
                            <span>输入:</span>
                            <span id="tokenInput">0</span>
                        </div>
                        <div class="token-item">
                            <span>输出:</span>
                            <span id="tokenOutput">0</span>
                        </div>
                        <div class="token-divider"></div>
                        <div class="token-item token-total">
                            <span>实际消耗:</span>
                            <span id="tokenTotal">0</span>
                        </div>
                    </div>
                </div>

                <!-- 消息区域 -->
                <div class="messages-container" id="messagesContainer">
                    <!-- AI正在输入提示 -->
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        突破次元遇见你…
                    </div>
                    
                    <!-- 消息列表 -->
                    <div class="messages-list" id="messagesList">
                        <!-- 消息会动态生成 -->
                    </div>
                </div>

                <!-- 底部输入栏 -->
<div class="input-bar" id="inputBar">
    <!-- 展开状态的输入框（默认隐藏） -->
    <div class="input-wrapper" id="inputWrapper">
        <textarea 
            class="input-field" 
            id="inputField" 
            placeholder="请停留于我手心…"
        ></textarea>
        <button class="expand-btn" id="expandBtn" title="收起">⬇</button>
    </div>
    
    <!-- 底部按钮行 -->
    <div class="input-bar-bottom">
        <button class="menu-btn" id="menuBtn">☰</button>
        <textarea 
            id="inputFieldInline" 
            rows="1" 
            placeholder="请停留于我手心…"
        ></textarea>
        <button class="inline-expand-btn" id="inlineExpandBtn" title="展开">⬆</button>
        <button class="ai-send-btn" id="aiSendBtn" title="AI发送">🤖</button>
        <button class="user-send-btn" id="userSendBtn" title="发送">📤</button>
    </div>
</div>

<!-- 菜单面板（展开） -->
<div class="menu-panel" id="menuPanel" style="display: none;">
    <!-- 菜单内容不变 -->
    <div class="menu-row">
        <button class="menu-item" id="menuResay" title="重说">
            <span class="menu-icon">🔄</span>
            <span class="menu-label">重说</span>
        </button>
        <button class="menu-item" id="menuEmoji" title="表情">
            <span class="menu-icon">😊</span>
            <span class="menu-label">表情</span>
        </button>
        <button class="menu-item" id="menuImage" title="图片">
            <span class="menu-icon">📷</span>
            <span class="menu-label">图片</span>
        </button>
        <button class="menu-item" id="menuVideo" title="视频">
            <span class="menu-icon">🎥</span>
            <span class="menu-label">视频</span>
        </button>
    </div>
    <div class="menu-row">
        <button class="menu-item" id="menuVoice" title="语音">
            <span class="menu-icon">🎤</span>
            <span class="menu-label">语音</span>
        </button>
        <button class="menu-item" id="menuFile" title="文件">
            <span class="menu-icon">📁</span>
            <span class="menu-label">文件</span>
        </button>
        <button class="menu-item menu-placeholder" id="menuListenTogether" title="一起听（开发中）">
            <span class="menu-icon">🎧</span>
            <span class="menu-label">一起听</span>
        </button>
        <button class="menu-item menu-placeholder" id="menuWatchTogether" title="一起看（开发中）">
            <span class="menu-icon">📺</span>
            <span class="menu-label">一起看</span>
        </button>
    </div>
</div>

                <!-- 状态弹窗（点击备注名） -->
                <div class="status-modal" id="statusModal" style="display: none;">
                    <div class="status-content">
                        <div class="status-item">
                            <span class="status-label">装扮:</span>
                            <span class="status-value" id="statusOutfit">加载中...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">动作:</span>
                            <span class="status-value" id="statusAction">加载中...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">心声:</span>
                            <span class="status-value" id="statusMood">加载中...</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">位置:</span>
                            <span class="status-value" id="statusLocation">加载中...</span>
                        </div>
                        <div class="status-divider"></div>
                        <button class="status-detail-btn" id="statusDetailBtn">查看详细资料</button>
                    </div>
                </div>
            </div>
            <!-- ==================== 聊天界面页结束 ==================== -->
            
        </div>
        <!-- ← pages-container 结束 -->

        <!-- 底部导航栏 -->
        <div class="bottom-nav">
            <button class="nav-btn active" data-page="chatListPage">
                <img src="assets/icons/chat/nav-chat.png" alt="聊天" class="nav-icon-img">
                <div class="nav-label">聊天</div>
            </button>
            <button class="nav-btn" data-page="friendListPage">
                <img src="assets/icons/chat/nav-friend.png" alt="好友" class="nav-icon-img">
                <div class="nav-label">好友</div>
            </button>
            <button class="nav-btn" data-page="discoverPage">
                <img src="assets/icons/chat/nav-discover.png" alt="发现" class="nav-icon-img">
                <div class="nav-label">发现</div>
            </button>
            <button class="nav-btn" data-page="profilePage">
                <img src="assets/icons/chat/nav-profile.png" alt="我" class="nav-icon-img">
                <div class="nav-label">我</div>
            </button>
        </div>
        
    </div>
    <!-- ← 聊天APP容器到这里结束 -->
    
    <!-- ==================== 人设编辑弹窗 ==================== -->
    <div class="modal-overlay" id="editFriendModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">编辑好友</h2>
                <button class="modal-close-btn" id="closeEditModal">×</button>
            </div>
            
            <div class="modal-content">
                <!-- 头像区域 -->
                <div class="edit-section">
                    <label class="edit-label">头像</label>
                    <div class="avatar-upload-area" id="avatarUploadArea">
                        <div class="avatar-preview" id="avatarPreview">
                            <span id="avatarPlaceholder">测</span>
                        </div>
                        <div class="avatar-upload-hint">点击上传头像</div>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                </div>
                
                <!-- 头像识别开关 -->
                <div class="edit-section switch-section">
                    <label class="edit-label">头像识别</label>
                    <label class="switch">
                        <input type="checkbox" id="avatarRecognitionSwitch" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- 真实姓名 -->
                <div class="edit-section">
                    <label class="edit-label">真实姓名</label>
                    <input type="text" class="edit-input" id="editRealName" placeholder="选填">
                </div>
                
                <!-- 网名 -->
                <div class="edit-section">
                    <label class="edit-label">网名 *</label>
                    <input type="text" class="edit-input" id="editName" placeholder="必填" required>
                </div>
                
                <!-- 备注 -->
                <div class="edit-section">
                    <label class="edit-label">备注</label>
                    <input type="text" class="edit-input" id="editNickname" placeholder="选填">
                </div>
                
                <!-- 个性签名 -->
                <div class="edit-section">
                    <label class="edit-label">个性签名</label>
                    <input type="text" class="edit-input" id="editSignature" placeholder="选填">
                </div>
                
                <!-- 人设 -->
                <div class="edit-section">
                    <label class="edit-label">人设（Persona）</label>
                    <textarea class="edit-textarea" id="editPersona" rows="8" placeholder="在这里随意编写角色人设...&#10;&#10;你可以写：&#10;- 简单的一句话&#10;- 或者详细的性格、背景、关系等&#10;&#10;参考SillyTavern的人设框"></textarea>
                </div>
                
                <!-- 拍一拍 -->
                <div class="edit-section">
                    <label class="edit-label">拍一拍</label>
                    <input type="text" class="edit-input" id="editPoke" placeholder="例如：戳了戳你的头">
                </div>
                
                <!-- 保存按钮 -->
                <button class="save-btn" id="saveFriendBtn">保存</button>
                
                <!-- 危险操作区 -->
                <div class="danger-zone">
                    <div class="danger-zone-title">危险操作</div>
                    <button class="delete-btn" id="deleteFriendBtn">删除好友</button>
                </div>
            </div>
        </div>
    </div>
    
       <!-- ==================== 添加好友选择弹窗 ==================== -->
    <div class="modal-overlay" id="addFriendChoiceModal" style="display: none;">
        <div class="modal-container small">
            <div class="modal-header">
                <h2 class="modal-title">添加好友</h2>
                <button class="modal-close-btn" id="closeAddChoiceModal">×</button>
            </div>
            
            <div class="modal-content">
                <button class="choice-btn" id="newFriendBtn">
                    <span class="choice-icon">📝</span>
                    <span class="choice-text">新建好友</span>
                </button>
                
                <button class="choice-btn" id="addByCodeBtn">
                    <span class="choice-icon">🔢</span>
                    <span class="choice-text">通过编码添加</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ==================== 新建好友弹窗 ==================== -->
    <div class="modal-overlay" id="newFriendModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">新建好友</h2>
                <button class="modal-close-btn" id="closeNewFriendModal">×</button>
            </div>
            
            <div class="modal-content">
                <!-- 网名 -->
                <div class="edit-section">
                    <label class="edit-label">网名 *</label>
                    <input type="text" class="edit-input" id="newFriendName" placeholder="必填" required>
                </div>
                
                <!-- 备注 -->
                <div class="edit-section">
                    <label class="edit-label">备注</label>
                    <input type="text" class="edit-input" id="newFriendNickname" placeholder="选填">
                </div>
                
                <!-- 个性签名 -->
                <div class="edit-section">
                    <label class="edit-label">个性签名</label>
                    <input type="text" class="edit-input" id="newFriendSignature" placeholder="选填">
                </div>
                
                <!-- 人设 -->
                <div class="edit-section">
                    <label class="edit-label">人设（Persona）</label>
                    <textarea class="edit-textarea" id="newFriendPersona" rows="6" placeholder="在这里随意编写角色人设..."></textarea>
                </div>
                
                <!-- 拍一拍 -->
                <div class="edit-section">
                    <label class="edit-label">拍一拍</label>
                    <input type="text" class="edit-input" id="newFriendPoke" placeholder="例如：戳了戳你的头">
                </div>
                
                <!-- 创建按钮 -->
                <button class="save-btn" id="createFriendBtn">创建</button>
            </div>
        </div>
    </div>
    
    <!-- ==================== 通过编码添加弹窗 ==================== -->
    <div class="modal-overlay" id="addByCodeModal" style="display: none;">
        <div class="modal-container small">
            <div class="modal-header">
                <h2 class="modal-title">通过编码添加</h2>
                <button class="modal-close-btn" id="closeAddByCodeModal">×</button>
            </div>
            
            <div class="modal-content">
                <div class="edit-section">
                    <label class="edit-label">输入好友编码</label>
                    <input type="text" class="edit-input" id="friendCodeInput" placeholder="例如：TEST_2k25_ABC#">
                    <div class="code-hint">编码格式：XXX_年份_随机#</div>
                </div>
                
                <!-- 添加按钮 -->
                <button class="save-btn" id="addByCodeConfirmBtn">添加</button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript文件引入 -->
    <script src="js/chat/storage.js"></script>
    <script src="js/chat/chat-interface.js"></script>  <!-- ← 加这行，注意顺序！ -->
    <script src="js/chat/chat-app.js"></script>
    
</body>
</html>